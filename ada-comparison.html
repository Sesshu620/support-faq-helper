<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardano ADA Price Comparison - Buy at Best Price</title>
    
<!-- 共通メニュー用のCSS -->
<style>
.nav-menu {
    background-color: #f8f9fa;
    padding: 1rem 0;
    margin-bottom: 2rem;
    border-bottom: 1px solid #dee2e6;
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.nav-links {
    display: flex;
    gap: 2rem;
    list-style: none;
    margin: 0;
    padding: 0;
    flex-wrap: wrap;
}

.nav-links a {
    text-decoration: none;
    color: #6f42c1;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.nav-links a:hover {
    background-color: #e2e6ea;
}

.nav-links a.active {
    background-color: #6f42c1;
    color: white;
}

@media (max-width: 768px) {
    .nav-links {
        gap: 1rem;
    }
    
    .nav-links a {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
    }
}
</style>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .ada-info {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .price-label {
            font-size: 1.1em;
            font-weight: 700;
            color: #0f4c75;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ada-price {
            font-size: 2.8em;
            font-weight: bold;
            color: #0f4c75;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .price-change {
            margin-left: 10px;
            font-size: 1em;
            font-weight: 600;
        }

        .price-change.positive {
            color: #28a745;
        }

        .price-change.negative {
            color: #dc3545;
        }

        .last-update {
            color: #666;
            font-size: 0.9em;
        }

        .controls {
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
        }

        .location-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #0f4c75;
            border-radius: 25px;
            font-weight: 600;
            color: #0f4c75;
            font-size: 0.95em;
        }

        .location-icon {
            font-size: 1.2em;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .refresh-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            color: #666;
            font-size: 0.9em;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
        }

        .exchange-grid {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .exchange-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .exchange-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .exchange-card.best-price {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
        }

        .best-price-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .exchange-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .exchange-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .exchange-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .exchange-id {
            font-size: 0.9em;
            color: #666;
        }

        .price-info {
            margin-bottom: 20px;
        }

        .price {
            font-size: 2em;
            font-weight: bold;
            color: #0f4c75;
            margin-bottom: 5px;
        }

        .price-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .volume {
            font-weight: 600;
        }

        .exchange-features {
            list-style: none;
            margin-bottom: 20px;
        }

        .exchange-features li {
            padding: 5px 0;
            color: #666;
            font-size: 0.9em;
        }

        .exchange-features li::before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }

        .visit-btn {
            width: 100%;
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .visit-btn:hover {
            background: linear-gradient(135deg, #0a3a5c, #2a6b99);
            transform: translateY(-2px);
        }

        .disclaimer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 10px;
            color: #856404;
            font-size: 0.9em;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .ada-info {
                flex-direction: column;
                text-align: center;
            }
            
            .controls {
                justify-content: center;
            }
            
            .exchange-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 共通メニュー -->
    <nav class="nav-menu">
        <div class="nav-container">
            <ul class="nav-links">
                <li><a href="index.html" id="nav-faq">FAQ</a></li>
                <li><a href="cards.html" id="nav-cards">Crypto Cards</a></li>
                <li><a href="ada-comparison.html" id="nav-ada">ADA Price Comparison</a></li>
                <li><a href="crypto-tax.html" id="nav-tax">Tax Rates</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <img src="cardano-ada-logo.svg" 
                 alt="Cardano Logo" 
                 width="60" 
                 height="60" 
                 style="display: inline-block; vertical-align: middle; margin-right: 15px;">
            <h1 style="display: inline-block; vertical-align: middle;">Cardano ADA Price Comparison</h1>
            <p>Find the best exchange to buy ADA at the lowest price in your currency</p>
        </div>

        <div class="ada-info">
            <div>
                <div class="price-label">1 ADA =</div>
                <div class="ada-price" id="currentPrice">Loading...</div>
                <div class="price-details">
                    <span id="currentPriceLocal" style="font-size: 1em; color: #666; font-weight: 500;"></span>
                    <span class="price-change" id="priceChange">--</span>
                </div>
            </div>
            <div class="last-update" id="lastUpdate">Last updated: --:--</div>
        </div>

        <div class="controls">
            <button class="refresh-btn" id="refreshBtn">
                <span class="loading" id="loadingSpinner" style="display: none;">
                    <span class="loading-spinner"></span>
                </span>
                🔄 Refresh Prices
            </button>
            <div class="location-badge" id="status">
                <span class="location-icon">🌍</span>
                <span>Detecting location...</span>
            </div>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;"></div>

        <div class="exchange-grid" id="exchangeGrid">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-logo">⏳</div>
                    <div>
                        <div class="exchange-name">Loading...</div>
                        <div class="exchange-id">Fetching exchange data</div>
                    </div>
                </div>
                <div class="price-info">
                    <div class="price">$--</div>
                    <div class="price-details">
                        <span>Volume: --</span>
                        <span>Spread: --</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>⚠️ Disclaimer:</strong>
            Prices are fetched from CoinGecko API and are for reference only. Exchanges shown are filtered based on your detected location. Please verify actual trading prices on each exchange before making any trades. Cryptocurrency trading involves high risk. Always do your own research and invest responsibly.
        </div>
    </div>

    <script>
        const EXCHANGE_CONFIG = {
            binance: { name: 'Binance', logo: 'BN', url: 'https://www.binance.com/en/trade/ADA_USDT', features: ['World\'s largest trading volume', 'Low trading fees (0.1%)', 'Wide variety of trading pairs'], countries: ['GLOBAL'] },
            binance_us: { name: 'Binance.US', logo: 'BUS', url: 'https://www.binance.us/en/trade/pro/ADA_USD', features: ['US-compliant trading', 'Low fees', 'Advanced charting'], countries: ['US'] },
            gdax: { name: 'Coinbase Pro', logo: 'CB', url: 'https://pro.coinbase.com/trade/ADA-USD', features: ['Professional trading', 'High liquidity', 'Regulatory compliant'], countries: ['US', 'GB', 'CA', 'AU', 'SG', 'GLOBAL'] },
            kraken: { name: 'Kraken', logo: 'KR', url: 'https://www.kraken.com/prices/ada-cardano-price-chart', features: ['Established since 2011', 'Advanced trading features', 'Strong security record'], countries: ['US', 'GB', 'CA', 'AU', 'EU', 'GLOBAL'] },
            kucoin: { name: 'KuCoin', logo: 'KC', url: 'https://www.kucoin.com/trade/ADA-USDT', features: ['Diverse token selection', 'Staking rewards available', 'Trading bonuses'], countries: ['GLOBAL'] },
            bybit_spot: { name: 'Bybit', logo: 'BB', url: 'https://www.bybit.com/en-US/trade/spot/ADA/USDT', features: ['Derivatives trading', 'High liquidity', 'Copy trading'], countries: ['GLOBAL'] },
            okex: { name: 'OKX', logo: 'OK', url: 'https://www.okx.com/trade-spot/ada-usdt', features: ['Global exchange', 'DeFi products', 'NFT marketplace'], countries: ['GLOBAL'] },
            bitget: { name: 'Bitget', logo: 'BG', url: 'https://www.bitget.com/spot/ADAUSDT', features: ['Copy trading leader', 'Futures trading', 'Social trading'], countries: ['GLOBAL'] },
            gate: { name: 'Gate.io', logo: 'GT', url: 'https://www.gate.io/trade/ADA_USDT', features: ['Wide altcoin selection', 'Copy trading', 'Lending services'], countries: ['GLOBAL'] },
            mxc: { name: 'MEXC', logo: 'MX', url: 'https://www.mexc.com/exchange/ADA_USDT', features: ['Low trading fees', 'New token listings', 'Futures trading'], countries: ['GLOBAL'] },
            huobi: { name: 'HTX', logo: 'HT', url: 'https://www.htx.com/en-us/trade/ada_usdt', features: ['Global presence', 'DeFi integration', 'Margin trading'], countries: ['GLOBAL'] },
            bitfinex: { name: 'Bitfinex', logo: 'BF', url: 'https://www.bitfinex.com/t/ADA:USD', features: ['Professional trading', 'Margin trading', 'Lending'], countries: ['GLOBAL'] },
            bingx: { name: 'BingX', logo: 'BX', url: 'https://bingx.com/en-us/spot/ADAUSDT', features: ['Copy trading', 'Grid trading', 'Social features'], countries: ['GLOBAL'] },
            bitstamp: { name: 'Bitstamp', logo: 'BS', url: 'https://www.bitstamp.net/markets/ada/usd/', features: ['EU regulated', 'Established 2011', 'High security'], countries: ['US', 'GB', 'EU', 'GLOBAL'] },
            whitebit: { name: 'WhiteBIT', logo: 'WB', url: 'https://whitebit.com/trade/ADA_USDT', features: ['European exchange', 'Smart staking', 'Low fees'], countries: ['EU', 'GLOBAL'] },
            coinex: { name: 'CoinEx', logo: 'CE', url: 'https://www.coinex.com/exchange/ada-usdt', features: ['Global exchange', 'Mining pool', 'Perpetual trading'], countries: ['GLOBAL'] },
            xt: { name: 'XT.COM', logo: 'XT', url: 'https://www.xt.com/tradePro/ada_usdt', features: ['Social trading', 'Copy trading', 'Futures'], countries: ['GLOBAL'] },
            bitrue: { name: 'Bitrue', logo: 'BR', url: 'https://www.bitrue.com/trade/ada_usdt', features: ['XRP-focused', 'Power piggy', 'Staking'], countries: ['GLOBAL'] },
            pionex: { name: 'Pionex', logo: 'PX', url: 'https://www.pionex.com/en-US/trade/ADA_USDT', features: ['Built-in trading bots', 'Grid trading', 'DCA bot'], countries: ['GLOBAL'] },
            bit2me: { name: 'Bit2Me', logo: 'B2M', url: 'https://bit2me.com/price/cardano', features: ['European focus', 'Regulated in Spain', 'Earn products'], countries: ['ES', 'EU'] },
            coinspot: { name: 'CoinSpot', logo: 'CS', url: 'https://www.coinspot.com.au/buy/ada', features: ['Australian owned', 'AUD deposits', 'Local support'], countries: ['AU'] },
            independent_reserve: { name: 'Independent Reserve', logo: 'IR', url: 'https://www.independentreserve.com/market/ada', features: ['Australian regulated', 'High security', 'AUD/NZD support'], countries: ['AU', 'NZ'] },
            bitflyer: { name: 'bitFlyer', logo: 'BF', url: 'https://bitflyer.com/en-jp/ex/simple', features: ['Japan\'s largest', 'FSA licensed', 'Insurance coverage'], countries: ['JP'] },
            coincheck: { name: 'Coincheck', logo: 'CC', url: 'https://coincheck.com/exchange', features: ['Beginner friendly', 'Mobile app', 'NFT marketplace'], countries: ['JP'] },
            gmo_japan: { name: 'GMOコイン', logo: 'GMO', url: 'https://coin.z.com/jp/corp/product/info/ada/', features: ['GMO Group', 'No trading fees', 'Staking rewards'], countries: ['JP'] },
            bitbank: { name: 'bitbank', logo: 'BB', url: 'https://bitbank.cc/markets', features: ['High liquidity', 'Advanced charts', 'Security'], countries: ['JP'] },
            sbi_vc: { name: 'SBI VCトレード', logo: 'SBI', url: 'https://www.sbivc.co.jp/services/ada', features: ['SBI Group', 'Financial license', 'Security focus'], countries: ['JP'] },
            bitpoint: { name: 'BITPoint', logo: 'BP', url: 'https://www.bitpoint.co.jp/trade/', features: ['No trading fees', 'Lending service', 'ADA staking'], countries: ['JP'] }
        };

        const CURRENCY_CONFIG = {
            'US': { currency: 'USD', symbol: '$', name: 'US Dollar' },
            'AU': { currency: 'AUD', symbol: 'A$', name: 'Australian Dollar' },
            'JP': { currency: 'JPY', symbol: '¥', name: 'Japanese Yen' },
            'GB': { currency: 'GBP', symbol: '£', name: 'British Pound' },
            'EU': { currency: 'EUR', symbol: '€', name: 'Euro' },
            'CA': { currency: 'CAD', symbol: 'C$', name: 'Canadian Dollar' },
            'NZ': { currency: 'NZD', symbol: 'NZ$', name: 'New Zealand Dollar' },
            'SG': { currency: 'SGD', symbol: 'S$', name: 'Singapore Dollar' },
            'KR': { currency: 'KRW', symbol: '₩', name: 'Korean Won' },
            'DEFAULT': { currency: 'USD', symbol: '$', name: 'US Dollar' }
        };

        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const ADA_TICKERS_URL = `${COINGECKO_API}/coins/cardano/tickers`;
        const IP_API_URL = 'https://ipapi.co/json/';

        let userCountry = 'US', userCurrency = 'USD', userCurrencySymbol = '$';
        let exchangeData = [], currencyRates = {}, isLoading = false;

        function formatPrice(price) { return parseFloat(price).toFixed(2); }
        function formatVolume(volume) {
            if (volume >= 1000000) return `${userCurrencySymbol}${(volume/1000000).toFixed(1)}M`;
            if (volume >= 1000) return `${userCurrencySymbol}${(volume/1000).toFixed(0)}K`;
            return `${userCurrencySymbol}${volume.toFixed(0)}`;
        }
        function formatPercentage(change) { return `${change >= 0 ? '+' : ''}${parseFloat(change).toFixed(2)}%`; }
        function convertPrice(usdPrice) {
            const key = userCurrency.toLowerCase();
            if (currencyRates[key]) return usdPrice * (currencyRates[key] / currencyRates.usd);
            return usdPrice;
        }

        async function detectUserLocation() {
            try {
                const response = await fetch(IP_API_URL);
                if (!response.ok) throw new Error('Failed');
                const data = await response.json();
                userCountry = data.country_code || 'US';
                const currencyInfo = CURRENCY_CONFIG[userCountry] || CURRENCY_CONFIG['DEFAULT'];
                userCurrency = currencyInfo.currency;
                userCurrencySymbol = currencyInfo.symbol;
                console.log(`Detected location: ${userCountry}, Currency: ${userCurrency} (${userCurrencySymbol})`);
                const statusEl = document.getElementById('status');
                if (statusEl) statusEl.innerHTML = `<span class="location-icon">📍</span><span>${data.country_name || userCountry} • ${currencyInfo.name}</span>`;
                return userCountry;
            } catch (error) {
                console.error('Error detecting location:', error);
                const statusEl = document.getElementById('status');
                if (statusEl) statusEl.innerHTML = `<span class="location-icon">🌍</span><span>Location Unknown • US Dollar</span>`;
                return 'US';
            }
        }

        async function fetchExchangeRates() {
            const currencies = Object.values(CURRENCY_CONFIG).map(c => c.currency.toLowerCase()).join(',');
            const response = await fetch(`${COINGECKO_API}/simple/price?ids=cardano&vs_currencies=${currencies}&include_24hr_change=true`);
            const data = await response.json();
            currencyRates = data.cardano;
            console.log('Currency rates:', currencyRates);
            return { price: currencyRates[userCurrency.toLowerCase()], change24h: currencyRates[`${userCurrency.toLowerCase()}_24h_change`] || currencyRates.usd_24h_change };
        }

        async function fetchADATickers() {
            const response = await fetch(ADA_TICKERS_URL);
            const data = await response.json();
            return data.tickers || [];
        }

        function processExchangeData(tickers) {
            const exchangeMap = new Map();
            console.log('Total tickers:', tickers.length, 'Country:', userCountry);
            const validTargets = ['usd', 'usdt', 'usdc', 'eur', 'jpy', 'gbp', 'krw', 'try', 'fdusd', 'aud', 'cad', 'nzd', 'sgd'];
            tickers.forEach(ticker => {
                const exchangeId = ticker.market?.identifier?.toLowerCase();
                if (!exchangeId) return;
                const exchangeConfig = EXCHANGE_CONFIG[exchangeId];
                if (!exchangeConfig) return;
                const availableInCountry = exchangeConfig.countries.includes(userCountry) || exchangeConfig.countries.includes('GLOBAL');
                if (!availableInCountry) return;
                const target = ticker.target?.toLowerCase();
                if (!target || !validTargets.includes(target)) return;
                const price = parseFloat(ticker.last);
                const volume = parseFloat(ticker.volume);
                if (isNaN(price) || price <= 0) return;
                if (!exchangeMap.has(exchangeId) || volume > exchangeMap.get(exchangeId).volume) {
                    exchangeMap.set(exchangeId, { id: exchangeId, name: exchangeConfig.name, logo: exchangeConfig.logo, url: exchangeConfig.url, features: exchangeConfig.features, price, volume, pair: ticker.base + '/' + ticker.target });
                }
            });
            const exchanges = Array.from(exchangeMap.values()).filter(e => e.price > 0).sort((a, b) => a.price - b.price);
            console.log(`Final exchanges: ${exchanges.length}`);
            return exchanges.slice(0, 15);
        }

        function updatePriceHeader(priceData) {
            document.getElementById('currentPrice').textContent = `${userCurrencySymbol}${formatPrice(priceData.price)}`;
            document.getElementById('currentPriceLocal').textContent = userCurrency !== 'USD' && currencyRates.usd ? `(≈ $${formatPrice(currencyRates.usd)} USD)` : '';
            if (priceData.change24h !== undefined) {
                const el = document.getElementById('priceChange');
                el.textContent = formatPercentage(priceData.change24h);
                el.className = `price-change ${priceData.change24h >= 0 ? 'positive' : 'negative'}`;
            }
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        function renderExchangeCards() {
            const grid = document.getElementById('exchangeGrid');
            if (exchangeData.length === 0) {
                grid.innerHTML = '<div class="exchange-card"><div class="exchange-header"><div class="exchange-name">No exchange data available</div></div></div>';
                return;
            }
            grid.innerHTML = exchangeData.map((exchange, index) => {
                const localPrice = convertPrice(exchange.price);
                return `<div class="exchange-card ${index === 0 ? 'best-price' : ''}">
                    ${index === 0 ? '<div class="best-price-badge">🏆 Best Price</div>' : ''}
                    <div class="exchange-header">
                        <div class="exchange-logo">${exchange.logo}</div>
                        <div><div class="exchange-name">${exchange.name}</div><div class="exchange-id">${exchange.pair}</div></div>
                    </div>
                    <div class="price-info">
                        <div class="price">${userCurrencySymbol}${formatPrice(localPrice)}</div>
                        <div class="price-details">
                            <span class="volume">Vol: ${formatVolume(exchange.volume)}</span>
                            ${userCurrency !== 'USD' ? `<span>$${formatPrice(exchange.price)}</span>` : ''}
                        </div>
                    </div>
                    <ul class="exchange-features">${exchange.features.slice(0, 3).map(f => `<li>${f}</li>`).join('')}</ul>
                    <button class="visit-btn" onclick="window.open('${exchange.url}', '_blank')">Buy on ${exchange.name}</button>
                </div>`;
            }).join('');
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = `Error: ${message}`;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function setLoadingState(loading) {
            isLoading = loading;
            document.getElementById('refreshBtn').disabled = loading;
            document.getElementById('loadingSpinner').style.display = loading ? 'inline-block' : 'none';
        }

        async function updatePrices() {
            if (isLoading) return;
            setLoadingState(true);
            hideError();
            try {
                const [priceData, tickers] = await Promise.all([fetchExchangeRates(), fetchADATickers()]);
                exchangeData = processExchangeData(tickers);
                updatePriceHeader(priceData);
                renderExchangeCards();
                console.log(`Updated with ${exchangeData.length} exchanges`);
            } catch (error) {
                console.error('Error updating prices:', error);
                showError('Failed to fetch price data. Please try again later.');
                if (exchangeData.length === 0) {
                    document.getElementById('exchangeGrid').innerHTML = '<div class="exchange-card"><div class="exchange-header"><div class="exchange-logo">⚠️</div><div class="exchange-name">Unable to load data</div></div><div class="price-info"><div class="price">API Error</div><div class="price-details"><span>Please try refreshing</span></div></div></div>';
                }
            } finally {
                setLoadingState(false);
            }
        }

        function setActiveMenuItem() {
            const currentPath = window.location.pathname;
            const currentFile = currentPath.split('/').pop() || 'index.html';
            document.querySelectorAll('.nav-links a').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href').split('/').pop() === currentFile) item.classList.add('active');
            });
        }

        document.getElementById('refreshBtn').addEventListener('click', updatePrices);
        document.addEventListener('DOMContentLoaded', async function() {
            setActiveMenuItem();
            await detectUserLocation();
            await updatePrices();
        });
        setInterval(updatePrices, 2 * 60 * 1000);
    </script>
</body>
</html>